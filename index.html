<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ã‹ã‚“ãŸã‚“æ–‡å­—èµ·ã“ã—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ï¼‰</title>
<style>
  :root{
    --bg:#f6f9fc; --card:#fff; --ink:#0f172a; --muted:#64748b; --accent:#2563eb;
  }
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #e6eef7}
  .wrap{max-width:1100px;margin:auto;padding:16px}
  h1{font-size:20px;margin:8px 0}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
  button,select{
    appearance:none;border:1px solid #dbe7f5;background:#fff;border-radius:10px;
    padding:10px 14px;font-weight:700;cursor:pointer
  }
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.danger{background:#ef4444;border-color:#ef4444;color:#fff}
  button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef6ff;color:#2563eb;border:1px solid #cfe3ff}
  .panel{background:var(--card);border:1px solid #e6eef7;border-radius:16px;padding:14px}
  #log{white-space:pre-wrap;line-height:1.6}
  .seg{margin:0 0 10px;border-left:3px solid #dbe7f5;padding-left:10px}
  .seg .ts{color:var(--muted);font-size:12px;margin-right:6px}
  .seg .spk{font-weight:800;margin-right:6px}
  .seg .final{color:#0f172a}
  .seg .interim{color:#6b7280}
  footer{padding:20px 0 60px;color:var(--muted);text-align:center}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ã‹ã‚“ãŸã‚“æ–‡å­—èµ·ã“ã—ï¼ˆWeb Speech / ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ / TXTå‡ºåŠ›ï¼‰</h1>
      <div class="toolbar">
        <button id="btnStart" class="primary">ğŸ™ï¸ éŒ²éŸ³ãƒ»æ–‡å­—èµ·ã“ã—é–‹å§‹</button>
        <button id="btnPause" disabled>â¸ ä¸€æ™‚åœæ­¢</button>
        <button id="btnResume" disabled>â–¶ å†é–‹</button>
        <button id="btnStop" class="danger" disabled>â–  åœæ­¢</button>
        <button id="btnSpeaker" title="è©±è€…ã‚’åˆ‡æ›¿ï¼ˆAâ†’Bâ†’Câ€¦ï¼‰">ğŸ‘¤ è©±è€…åˆ‡æ›¿</button>
        <button id="btnClear" title="ç”»é¢ã¨ä¸‹æ›¸ãã‚’æ¶ˆå»">ğŸ§¹ å…¨æ¶ˆå»</button>
        <button id="btnSaveTxt">ğŸ“ TXTã§ä¿å­˜</button>
        <button id="btnSaveAudio" title="åŒæ™‚éŒ²éŸ³ã®éŸ³å£°ã‚’ä¿å­˜ï¼ˆä»»æ„ï¼‰">ğŸ”Š éŸ³å£°ã‚’ä¿å­˜</button>
        <span class="badge" id="status">å¾…æ©Ÿä¸­</span>
      </div>
      <div class="row">
        <span class="badge">è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: 10ç§’ã”ã¨</span>
        <span class="badge">æ¨å¥¨: Chrome / Edge</span>
        <span class="badge">é•·æ™‚é–“å¯¾å¿œ: è‡ªå‹•å†èµ·å‹•</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="panel">
      <div id="log"></div>
    </div>
  </main>

  <footer>
    ä½¿ã„æ–¹: é–‹å§‹â†’è©±ã™â†’å¿…è¦ã«å¿œã˜ã¦ã€Œè©±è€…åˆ‡æ›¿ã€â†’åœæ­¢â†’TXTä¿å­˜ã€‚<br/>
    ç²¾åº¦ã‚’é«˜ã‚ãŸã„å ´åˆã¯ã€ä¿å­˜ã—ãŸéŸ³å£°ã‚’å¾Œã§é«˜ç²¾åº¦ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆWhisperç­‰ï¼‰ã«ã‹ã‘ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚
  </footer>

<script>
(() => {
  // ---- çŠ¶æ…‹ ----
  let recognizing = false;
  let paused = false;
  let recognizer = null;
  let interimSpan = null;
  let currentSpeaker = 'A';
  let startTime = null;

  // ç”ŸéŸ³å£°ï¼ˆä»»æ„ã§ä¿å­˜ç”¨ï¼‰
  let mediaRecorder = null;
  let audioChunks = [];

  // è¦ç´ 
  const $ = (id) => document.getElementById(id);
  const logEl = $('log');
  const statusEl = $('status');

  const btnStart = $('btnStart');
  const btnPause = $('btnPause');
  const btnResume = $('btnResume');
  const btnStop = $('btnStop');
  const btnSpeaker = $('btnSpeaker');
  const btnClear = $('btnClear');
  const btnSaveTxt = $('btnSaveTxt');
  const btnSaveAudio = $('btnSaveAudio');

  // ---- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----
  const fmtTS = (ms) => {
    const s = Math.floor(ms/1000);
    const hh = String(Math.floor(s/3600)).padStart(2,'0');
    const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  };

  const nowTS = () => startTime ? fmtTS(Date.now() - startTime) : '00:00:00';

  const addSegment = (text, {interim=false} = {}) => {
    const seg = document.createElement('div');
    seg.className = 'seg';
    const ts = document.createElement('span');
    ts.className = 'ts';
    ts.textContent = `[${nowTS()}]`;
    const spk = document.createElement('span');
    spk.className = 'spk';
    spk.textContent = `${currentSpeaker}:`;
    const body = document.createElement('span');
    body.className = interim ? 'interim' : 'final';
    body.textContent = text;

    seg.appendChild(ts);
    seg.appendChild(spk);
    seg.appendChild(body);
    logEl.appendChild(seg);

    if (interim) interimSpan = body; else interimSpan = null;
    // æœ«å°¾ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    seg.scrollIntoView({behavior:'smooth', block:'end'});
    backupSave();
  };

  const replaceInterim = (text) => {
    if (interimSpan) {
      interimSpan.textContent = text;
    } else {
      // ãªã‘ã‚Œã°ä½œã‚‹
      addSegment(text, {interim:true});
    }
  };

  const setStatus = (txt) => statusEl.textContent = txt;

  // ---- ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆ10ç§’ã”ã¨ï¼‰ ----
  function backupSave() {
    // è»½é‡ã®HTMLã§ä¿å­˜ï¼ˆè¡¨ç¤ºãã®ã¾ã¾ï¼‰
    localStorage.setItem('transcript_html_v1', logEl.innerHTML);
    localStorage.setItem('transcript_speaker_v1', currentSpeaker);
  }
  function backupLoad() {
    const html = localStorage.getItem('transcript_html_v1');
    if (html) logEl.innerHTML = html;
    const spk = localStorage.getItem('transcript_speaker_v1');
    if (spk) currentSpeaker = spk;
  }
  // å®šæœŸä¿å­˜ã‚¿ã‚¤ãƒãƒ¼
  setInterval(() => { if (recognizing || logEl.innerHTML) backupSave(); }, 10000);

  // ---- éŸ³å£°èªè­˜ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆè‡ªå‹•å†èµ·å‹•ã¤ãï¼‰----
  function createRecognizer() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ Web Speech API ã«æœªå¯¾å¿œã§ã™ã€‚Chromeç³»ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
      return null;
    }
    const r = new SR();
    r.lang = 'ja-JP';
    r.interimResults = true;
    r.continuous = true; // é€£ç¶š
    r.maxAlternatives = 1;

    r.onstart = () => setStatus('èªè­˜ä¸­...');
    r.onend = () => {
      setStatus(paused ? 'ä¸€æ™‚åœæ­¢ä¸­' : (recognizing ? 'å†èµ·å‹•ä¸­...' : 'åœæ­¢'));
      // åœæ­¢æŒ‡ç¤ºã§ãªã‘ã‚Œã°è‡ªå‹•å†èµ·å‹•
      if (recognizing && !paused) {
        setTimeout(() => { try { r.start(); } catch(e){} }, 200);
      }
    };
    r.onerror = (e) => {
      console.warn('Speech error:', e);
      setStatus('ã‚¨ãƒ©ãƒ¼: ' + (e.error || 'unknown'));
      // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼no-speechç­‰ã¯å†èµ·å‹•
      if (recognizing && !paused) {
        setTimeout(() => { try { r.start(); } catch(_){} }, 400);
      }
    };
    r.onresult = (ev) => {
      let interimText = '';
      for (let i = ev.resultIndex; i < ev.results.length; i++) {
        const res = ev.results[i];
        const txt = res[0].transcript;
        if (res.isFinal) {
          // ç¢ºå®šã¯è¡Œã‚’ç· ã‚ã‚‹
          addSegment(txt.trim(), {interim:false});
        } else {
          interimText += txt;
        }
      }
      if (interimText) replaceInterim(interimText);
    };
    return r;
  }

  // ---- ç”ŸéŸ³å£°ã®åŒæ™‚éŒ²éŸ³ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰----
  async function startAudioBackup() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      mediaRecorder = new MediaRecorder(stream, {mimeType: 'audio/webm'});
      audioChunks = [];
      mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size) audioChunks.push(e.data); };
      mediaRecorder.start(1000); // 1sã”ã¨ã«ãƒãƒ£ãƒ³ã‚¯
    } catch (e) {
      console.warn('ãƒã‚¤ã‚¯éŒ²éŸ³ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“:', e);
    }
  }
  function stopAudioBackup() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  }

  // ---- ãƒœã‚¿ãƒ³æŒ™å‹• ----
  btnStart.onclick = async () => {
    if (recognizing) return;
    backupLoad();
    startTime = Date.now();
    recognizer = createRecognizer();
    if (!recognizer) return;
    recognizing = true; paused = false;

    btnStart.disabled = true;
    btnPause.disabled = false;
    btnResume.disabled = true;
    btnStop.disabled = false;

    try { recognizer.start(); } catch(e){}
    await startAudioBackup();
    setStatus('èªè­˜ä¸­...');
  };

  btnPause.onclick = () => {
    if (!recognizing || paused) return;
    paused = true;
    try { recognizer.stop(); } catch(e){}
    setStatus('ä¸€æ™‚åœæ­¢ä¸­');
    btnPause.disabled = true;
    btnResume.disabled = false;
  };

  btnResume.onclick = () => {
    if (!recognizing || !paused) return;
    paused = false;
    try { recognizer.start(); } catch(e){}
    setStatus('èªè­˜ä¸­...');
    btnPause.disabled = false;
    btnResume.disabled = true;
  };

  btnStop.onclick = () => {
    recognizing = false; paused = false;
    try { recognizer.stop(); } catch(e){}
    stopAudioBackup();
    btnStart.disabled = false;
    btnPause.disabled = true;
    btnResume.disabled = true;
    btnStop.disabled = true;
    setStatus('åœæ­¢');
    backupSave();
  };

  btnSpeaker.onclick = () => {
    // A->B->C->D->A...
    const next = {A:'B', B:'C', C:'D', D:'A'};
    currentSpeaker = next[currentSpeaker] || 'A';
    backupSave();
    setStatus(`è©±è€…: ${currentSpeaker}`);
  };

  btnClear.onclick = () => {
    if (!confirm('ç”»é¢ã¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    logEl.innerHTML = '';
    localStorage.removeItem('transcript_html_v1');
    localStorage.removeItem('transcript_speaker_v1');
  };

  btnSaveTxt.onclick = () => {
    // ãƒ­ã‚°ã‹ã‚‰ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
    const segs = Array.from(logEl.querySelectorAll('.seg'));
    const lines = segs.map(seg => {
      const ts = seg.querySelector('.ts')?.textContent ?? '';
      const spk = seg.querySelector('.spk')?.textContent ?? '';
      const body = seg.querySelector('.final, .interim')?.textContent ?? '';
      return `${ts} ${spk} ${body}`.trim();
    });
    const blob = new Blob([lines.join('\n')], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const dt = new Date().toISOString().replaceAll(':','-').slice(0,19);
    a.download = `transcript_${dt}.txt`;
    a.click();
  };

  btnSaveAudio.onclick = () => {
    if (!audioChunks.length) {
      alert('ä¿å­˜ã§ãã‚‹éŸ³å£°ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆéŒ²éŸ³ã‚’é–‹å§‹ã—ã¦åœæ­¢ã—ã¦ãã ã•ã„ï¼‰');
      return;
    }
    const blob = new Blob(audioChunks, {type:'audio/webm'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const dt = new Date().toISOString().replaceAll(':','-').slice(0,19);
    a.download = `audio_${dt}.webm`;
    a.click();
  };

  // èµ·å‹•æ™‚ã«ä¸‹æ›¸ãå¾©å…ƒï¼ˆã‚ã‚Œã°ï¼‰
  backupLoad();
})();
</script>
</body>
</html>
