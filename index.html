<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ã‹ã‚“ãŸã‚“æ–‡å­—ãŠã“ã—ï¼ˆæ—¥æœ¬èªå›ºå®šãƒ»ãƒã‚¤ã‚¯é¸æŠãƒ»ãƒ¡ãƒ¼ã‚¿ãƒ¼ãƒ»ä¿å­˜/ã‚³ãƒ”ãƒ¼/å‰Šé™¤ãƒ»é‡è¤‡é˜²æ­¢ï¼‰</title>
<style>
  :root{ --bg:#f6f9fc; --card:#fff; --ink:#0f172a; --muted:#64748b; --accent:#2563eb; }
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #e6eef7;z-index:10}
  .wrap{max-width:1100px;margin:auto;padding:16px}
  h1{font-size:20px;margin:8px 0}
  h2{font-size:16px;margin:0 0 6px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
  button{appearance:none;border:1px solid #dbe7f5;background:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.danger{background:#ef4444;border-color:#ef4444;color:#fff}
  button:disabled{opacity:.5;cursor:not-allowed}
  select{border:1px solid #dbe7f5;border-radius:10px;padding:10px 12px;background:#fff}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef6ff;color:var(--accent);border:1px solid #cfe3ff}
  .panel{background:var(--card);border:1px solid #e6eef7;border-radius:16px;padding:14px;margin:12px 0}
  .meters{display:grid;grid-template-columns:120px 1fr;gap:16px;align-items:center;margin:6px 0 14px}
  .mic-bubble{width:90px;height:90px;border-radius:999px;background:#e6f0ff;border:2px solid #cfe3ff;display:grid;place-items:center;transition:transform .08s linear, box-shadow .1s linear;box-shadow:0 0 0 rgba(37,99,235,.0)}
  .mic-bubble.on{box-shadow:0 0 24px rgba(37,99,235,.35)}
  .mic-dot{width:16px;height:16px;border-radius:999px;background:#2563eb}
  .bar-wrap{height:14px;border-radius:999px;background:#eef3fb;overflow:hidden;border:1px solid #dbe7f5}
  .bar{height:100%;width:0%;background:#2563eb;transition:width .08s linear}
  #wave{width:100%;height:70px;display:block;background:#fafcff;border:1px dashed #dbe7f5;border-radius:10px}
  #log{white-space:pre-wrap;line-height:1.6}
  .seg{margin:0 0 10px;border-left:3px solid #dbe7f5;padding-left:10px}
  .seg .ts{color:var(--muted);font-size:12px;margin-right:6px}
  .seg .final{color:#0f172a}
  .seg .interim{color:#6b7280}
  .note{font-size:12px;color:var(--muted)}
  footer{padding:20px 0 60px;color:var(--muted);text-align:center}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ã‹ã‚“ãŸã‚“æ–‡å­—ãŠã“ã—</h1>
      <div class="toolbar">
        <button id="btnStart" class="primary">ğŸ™ï¸ é–‹å§‹</button>
        <button id="btnPause" disabled>â¸ ä¸€æ™‚åœæ­¢</button>
        <button id="btnResume" disabled>â–¶ å†é–‹</button>
        <button id="btnStop" class="danger" disabled>â–  åœæ­¢</button>
        <button id="btnQuickSave" title="ç¾åœ¨ã®æ–‡å­—ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜">ğŸ’¾ ä¿å­˜</button>
        <button id="btnCopy" title="ç¾åœ¨ã®æ–‡å­—ã‚’ã‚³ãƒ”ãƒ¼">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        <button id="btnClear" class="danger" title="å…¨æ¶ˆå»">ğŸ—‘ å‰Šé™¤</button>
        <span class="badge" id="status">å¾…æ©Ÿä¸­</span>
      </div>
      <div class="row">
        <label class="badge" style="background:#fff">ğŸ¤ ãƒã‚¤ã‚¯:
          <select id="micSelect" style="margin-left:6px"></select>
        </label>
        <span class="badge">æ—¥æœ¬èªå›ºå®šï¼ˆja-JPï¼‰</span>
        <span class="badge">æ¨å¥¨: PC Chrome / Edge</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="panel">
      <h2>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼ˆWeb Speech APIï¼‰</h2>
      <p class="note">iOS Safari ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èªè­˜ã«æœªå¯¾å¿œï¼ˆéŒ²éŸ³ã¯å¯ï¼‰ã€‚ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¾ã¾ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
      <div class="meters">
        <div class="mic-bubble" id="micBubble"><div class="mic-dot"></div></div>
        <div>
          <div class="bar-wrap"><div class="bar" id="levelBar"></div></div>
          <canvas id="wave"></canvas>
        </div>
      </div>
      <div id="log"></div>
    </div>
  </main>

  <footer>
    ğŸ™ï¸ é–‹å§‹ â†’ ãƒã‚¤ã‚¯è¨±å¯ â†’ ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒå‹•ã‘ã°å…¥åŠ›ä¸­ã€‚<br/>
    åŒã˜æ–‡ãŒ2å›å‡ºã‚‹ç¾è±¡ã‚’é˜²ããŸã‚ã€æš«å®šè¡Œã®æ˜‡æ ¼ã¨ç›´è¿‘finalã®ãƒ‡ãƒ‡ãƒ¥ãƒ¼ãƒ—ã‚’å®Ÿè£…æ¸ˆã¿ã§ã™ã€‚
  </footer>

<script>
(() => {
  // ===== çŠ¶æ…‹ =====
  let recognizing=false, paused=false, recognizer=null;
  let interimSegEl=null, interimBodyEl=null;  // æš«å®šè¡¨ç¤ºã®è¦ç´ 
  let lastFinalText='', lastFinalAt=0;        // ç›´è¿‘finalã®é‡è¤‡é˜²æ­¢
  let startTime=null;
  let micStream=null, audioCtx=null, analyser=null, timeData=null, rafId=null;
  let retryCount=0; const MAX_RETRY=6;
  let lastResultAt=Date.now();

  // è¦ç´ 
  const $=id=>document.getElementById(id);
  const logEl=$('log'), statusEl=$('status'), levelBar=$('levelBar'), micBubble=$('micBubble');
  const wave=$('wave'), wctx=wave.getContext('2d');
  const btnStart=$('btnStart'), btnPause=$('btnPause'), btnResume=$('btnResume'), btnStop=$('btnStop');
  const btnQuickSave=$('btnQuickSave'), btnCopy=$('btnCopy'), btnClear=$('btnClear');
  const micSelect=$('micSelect');

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  const fmtTS=ms=>{const s=Math.floor(ms/1000);return`${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`};
  const nowTS=()=>startTime?fmtTS(Date.now()-startTime):'00:00:00';
  const setStatus=txt=>statusEl.textContent=txt;

  function addSegment(text,{interim=false}={}) {
    const seg=document.createElement('div'); seg.className='seg';
    const ts=document.createElement('span'); ts.className='ts'; ts.textContent=`[${nowTS()}]`;
    const body=document.createElement('span'); body.className=interim?'interim':'final'; body.textContent=text;
    seg.appendChild(ts); seg.appendChild(body); logEl.appendChild(seg);

    if (interim) { interimSegEl=seg; interimBodyEl=body; }
    else { interimSegEl=null; interimBodyEl=null; }

    seg.scrollIntoView({behavior:'smooth', block:'end'});
    backupSave();
  }

  function replaceInterim(text) {
    if (interimBodyEl) {
      interimBodyEl.textContent = text;
    } else {
      addSegment(text, { interim: true });
    }
  }

  function backupSave(){ localStorage.setItem('transcript_html_v1', logEl.innerHTML); }
  function backupLoad(){ const html=localStorage.getItem('transcript_html_v1'); if (html) logEl.innerHTML = html; }
  setInterval(()=>{ if(recognizing || logEl.innerHTML) backupSave(); }, 10000);

  function quickSaveSnapshot(){
    const text = Array.from(logEl.querySelectorAll('.seg')).map(seg=>{
      const ts=seg.querySelector('.ts')?.textContent??''; const body=seg.querySelector('.final,.interim')?.textContent??'';
      return `${ts} ${body}`.trim();
    }).join('\n');
    const id=new Date().toISOString();
    const item={ id, savedAt:id, text, html:logEl.innerHTML };
    const key='transcript_snapshots_v1';
    const arr=JSON.parse(localStorage.getItem(key) || '[]'); arr.push(item);
    localStorage.setItem(key, JSON.stringify(arr));
    flash('ä¿å­˜ã—ã¾ã—ãŸ');
  }

  async function copyAll(){
    const text = Array.from(logEl.querySelectorAll('.seg')).map(seg=>{
      const ts=seg.querySelector('.ts')?.textContent??''; const body=seg.querySelector('.final,.interim')?.textContent??'';
      return `${ts} ${body}`.trim();
    }).join('\n');
    try{
      if (navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
      else {
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      }
      flash('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    } catch(e) {
      console.error(e); flash('ã‚³ãƒ”ãƒ¼å¤±æ•—');
    }
  }

  function flash(msg){ setStatus(msg); setTimeout(()=> setStatus(recognizing ? 'èªè­˜ä¸­...' : 'å¾…æ©Ÿä¸­'), 1500); }

  // ===== ãƒ‡ãƒã‚¤ã‚¹é¸æŠ =====
  async function listMics(){
    try { await navigator.mediaDevices.getUserMedia({ audio:true }); } catch(_) {}
    const devices = await navigator.mediaDevices.enumerateDevices();
    const mics = devices.filter(d=>d.kind==='audioinput');
    micSelect.innerHTML = mics.map(d=>`<option value="${d.deviceId}">${d.label || 'ãƒã‚¤ã‚¯'}</option>`).join('');
    const savedId = localStorage.getItem('preferred_mic_id');
    if (savedId && mics.some(m=>m.deviceId===savedId)) micSelect.value = savedId;
  }
  micSelect.addEventListener('change', ()=>{ localStorage.setItem('preferred_mic_id', micSelect.value || ''); });

  // ===== ãƒ¡ãƒ¼ã‚¿ãƒ¼åˆæœŸåŒ–ï¼ˆé¸æŠãƒã‚¤ã‚¯ï¼‰ =====
  async function initMicAndMeters(){
    if (micStream) return micStream;
    const deviceId = micSelect.value;
    micStream = await navigator.mediaDevices.getUserMedia({
      audio:{
        deviceId: deviceId ? { exact: deviceId } : undefined,
        echoCancellation:true, noiseSuppression:true, autoGainControl:true,
        channelCount:1, sampleRate:48000
      }
    });

    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
    const source = audioCtx.createMediaStreamSource(micStream);
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
    timeData = new Uint8Array(analyser.fftSize); source.connect(analyser);

    wave.width = wave.clientWidth * devicePixelRatio;
    wave.height = wave.clientHeight * devicePixelRatio;

    const loop = () => {
      analyser.getByteTimeDomainData(timeData);
      let sum=0; for (let i=0;i<timeData.length;i++){ const v=(timeData[i]-128)/128; sum += v*v; }
      const rms=Math.sqrt(sum/timeData.length), level=Math.min(1, rms*4);
      levelBar.style.width = (level*100).toFixed(0)+'%';
      micBubble.classList.toggle('on', level>0.04);
      micBubble.style.transform = `scale(${(1+Math.min(0.25, level*0.8)).toFixed(3)})`;

      const W=wave.width, H=wave.height, mid=H/2; const ctx=wctx; ctx.clearRect(0,0,W,H);
      ctx.lineWidth=2*devicePixelRatio; ctx.strokeStyle='#2563eb';
      ctx.beginPath(); const step=Math.ceil(timeData.length/W);
      for(let x=0,i=0;x<W;x++,i+=step){
        const yv=(timeData[Math.min(i,timeData.length-1)]-128)/128;
        const y=mid + yv*(H/2 - 4*devicePixelRatio);
        if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();

      rafId = requestAnimationFrame(loop);
    };
    rafId = requestAnimationFrame(loop);
    return micStream;
  }

  function stopMicAndMeters(){
    if (rafId) cancelAnimationFrame(rafId), rafId=null;
    if (audioCtx) audioCtx.close().catch(()=>{});
    micBubble.style.transform='scale(1)'; micBubble.classList.remove('on');
  }

  // ===== å†æ¥ç¶šï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰ =====
  function restartWithBackoff(rec){
    const delay = Math.min(30000, 500 * Math.pow(2, retryCount)) + Math.floor(Math.random()*300);
    retryCount++;
    setStatus(`å†æ¥ç¶šä¸­... (${retryCount})`);
    setTimeout(()=>{ try{ rec.start(); }catch{} }, delay);
  }

  // ===== éŸ³å£°èªè­˜ï¼ˆæ—¥æœ¬èªå›ºå®šãƒ»é‡è¤‡é˜²æ­¢ï¼‰ =====
  function createRecognizer(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ Web Speech API ã«æœªå¯¾å¿œã§ã™ã€‚Chrome/Edge ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚'); return null; }

    const r = new SR();
    r.lang = 'ja-JP';
    r.interimResults = true;
    r.continuous = true;
    r.maxAlternatives = 1;

    r.onstart = () => { setStatus('èªè­˜ä¸­...ï¼ˆlang=ja-JPï¼‰'); retryCount = 0; lastResultAt = Date.now(); };

    r.onend   = () => {
      if (!recognizing || paused) { setStatus(paused ? 'ä¸€æ™‚åœæ­¢ä¸­' : 'åœæ­¢'); return; }
      if (retryCount < MAX_RETRY) restartWithBackoff(r);
      else setStatus('æ¥ç¶šã§ãã¾ã›ã‚“ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/æ‹¡å¼µæ©Ÿèƒ½/FWã‚’ç¢ºèªï¼‰');
    };

    r.onerror = (e) => {
      console.warn('Speech error:', e);
      if (!recognizing || paused) return;
      if (retryCount < MAX_RETRY) restartWithBackoff(r);
      else setStatus('æ¥ç¶šã§ãã¾ã›ã‚“ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/æ‹¡å¼µæ©Ÿèƒ½/FWã‚’ç¢ºèªï¼‰');
    };

    r.onresult = (ev) => {
      let interim = '';
      for (let i = ev.resultIndex; i < ev.results.length; i++) {
        const res = ev.results[i];
        const txt = res[0].transcript;

        if (res.isFinal) {
          const cleaned = txt.trim()
            .replace(/\s+/g, ' ')
            .replace(/(ã§ã™|ã¾ã™)(?!ã€‚|ï¼|ï¼Ÿ)/g, '$1ã€‚');

          // (A) ç›´è¿‘finalã¨åŒä¸€ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ3ç§’ä»¥å†…ã¯å†é€ã¨ã¿ãªã™ï¼‰
          const now = Date.now();
          if (cleaned === lastFinalText && now - lastFinalAt < 3000) {
            continue;
          }

          // (B) æš«å®šè¡ŒãŒã‚ã‚Œã°æ˜‡æ ¼ï¼ˆæ–°ã—ã„è¡Œã‚’å¢—ã‚„ã•ãªã„ï¼‰
          if (interimBodyEl && interimSegEl) {
            interimBodyEl.className = 'final';
            interimBodyEl.textContent = cleaned;
            interimSegEl = null;
            interimBodyEl = null;
            backupSave();
          } else {
            // ã„ããªã‚ŠfinalãŒæ¥ãŸå ´åˆã®ã¿æ–°è¦è¿½åŠ 
            addSegment(cleaned, { interim: false });
          }

          lastFinalText = cleaned;
          lastFinalAt = now;

        } else {
          interim += txt;
        }
      }

      if (interim) replaceInterim(interim);
      lastResultAt = Date.now();
    };

    return r;
  }

  // ===== ã‚¦ã‚©ãƒƒãƒãƒ‰ãƒƒã‚°ï¼š30ç§’é–“çµæœãªã—â†’å†èµ·å‹• =====
  setInterval(()=>{
    if (recognizing && !paused && Date.now() - lastResultAt > 30000) {
      try { recognizer.stop(); } catch {}
      // onend â†’ å†æ¥ç¶šãƒ•ãƒ­ãƒ¼ã¸
    }
  }, 5000);

  // ===== ãƒœã‚¿ãƒ³å‹•ä½œ =====
  btnStart.onclick = async () => {
    if (recognizing) return;
    backupLoad(); startTime = Date.now();

    try { await initMicAndMeters(); }
    catch (e) { alert('ãƒã‚¤ã‚¯æ¨©é™ã‚’ã”ç¢ºèªãã ã•ã„ï¼ˆğŸ”’â†’ã‚µã‚¤ãƒˆã®è¨­å®šï¼‰'); console.error(e); return; }

    recognizer = createRecognizer(); if (!recognizer) return;
    recognizing = true; paused = false;

    btnStart.disabled = true; btnPause.disabled = false; btnResume.disabled = true; btnStop.disabled = false;
    try { recognizer.start(); } catch(e){}
    setStatus('èªè­˜ä¸­...ï¼ˆlang=ja-JPï¼‰');
  };

  btnPause.onclick = () => {
    if (!recognizing || paused) return;
    paused = true;
    try { recognizer.stop(); } catch{}
    setStatus('ä¸€æ™‚åœæ­¢ä¸­');
    btnPause.disabled = true; btnResume.disabled = false;
  };

  btnResume.onclick = () => {
    if (!recognizing || !paused) return;
    paused = false;
    try { recognizer.start(); } catch{}
    setStatus('èªè­˜ä¸­...ï¼ˆlang=ja-JPï¼‰');
    btnPause.disabled = false; btnResume.disabled = true;
  };

  btnStop.onclick = () => {
    recognizing = false; paused = false;
    try { recognizer.stop(); } catch{}
    stopMicAndMeters();
    btnStart.disabled = false; btnPause.disabled = true; btnResume.disabled = true; btnStop.disabled = true;
    setStatus('åœæ­¢');
    backupSave();
  };

  btnQuickSave.onclick = () => quickSaveSnapshot();
  btnCopy.onclick      = () => copyAll();
  btnClear.onclick     = () => {
    if (!confirm('ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    logEl.innerHTML = '';
    localStorage.removeItem('transcript_html_v1');
    setStatus('å‰Šé™¤ã—ã¾ã—ãŸ'); setTimeout(()=>setStatus('å¾…æ©Ÿä¸­'), 1500);
  };

  // åˆæœŸåŒ–ï¼šãƒã‚¤ã‚¯ä¸€è¦§
  (async () => { await listMics(); })();
})();
</script>
</body>
</html>
