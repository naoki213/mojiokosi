<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ã‹ã‚“ãŸã‚“æ–‡å­—ãŠã“ã—ï¼ˆæ—¥æœ¬èªå›ºå®šãƒ»èªå½™è¾æ›¸åˆ‡æ›¿ãƒ»ãƒã‚¤ã‚¯é¸æŠãƒ»ãƒ¡ãƒ¼ã‚¿ãƒ¼ãƒ»ä¿å­˜/ã‚³ãƒ”ãƒ¼/å‰Šé™¤ï¼‰</title>
<style>
  :root{ --bg:#f6f9fc; --card:#fff; --ink:#0f172a; --muted:#64748b; --accent:#2563eb; }
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #e6eef7;z-index:10}
  .wrap{max-width:1100px;margin:auto;padding:16px}
  h1{font-size:20px;margin:8px 0}
  h2{font-size:16px;margin:0 0 6px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
  button{appearance:none;border:1px solid #dbe7f5;background:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.danger{background:#ef4444;border-color:#ef4444;color:#fff}
  button:disabled{opacity:.5;cursor:not-allowed}
  select{border:1px solid #dbe7f5;border-radius:10px;padding:10px 12px;background:#fff}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef6ff;color:var(--accent);border:1px solid #cfe3ff}
  .panel{background:var(--card);border:1px solid #e6eef7;border-radius:16px;padding:14px;margin:12px 0}
  .meters{display:grid;grid-template-columns:120px 1fr;gap:16px;align-items:center;margin:6px 0 14px}
  .mic-bubble{width:90px;height:90px;border-radius:999px;background:#e6f0ff;border:2px solid #cfe3ff;display:grid;place-items:center;transition:transform .08s linear, box-shadow .1s linear;box-shadow:0 0 0 rgba(37,99,235,.0)}
  .mic-bubble.on{box-shadow:0 0 24px rgba(37,99,235,.35)}
  .mic-dot{width:16px;height:16px;border-radius:999px;background:#2563eb}
  .bar-wrap{height:14px;border-radius:999px;background:#eef3fb;overflow:hidden;border:1px solid #dbe7f5}
  .bar{height:100%;width:0%;background:#2563eb;transition:width .08s linear}
  #wave{width:100%;height:70px;display:block;background:#fafcff;border:1px dashed #dbe7f5;border-radius:10px}
  #log{white-space:pre-wrap;line-height:1.6}
  .seg{margin:0 0 10px;border-left:3px solid #dbe7f5;padding-left:10px}
  .seg .ts{color:var(--muted);font-size:12px;margin-right:6px}
  .seg .final{color:#0f172a}
  .seg .interim{color:#6b7280}
  .note{font-size:12px;color:var(--muted)}
  footer{padding:20px 0 60px;color:var(--muted);text-align:center}
  .toggle{display:flex;align-items:center;gap:6px;margin-left:6px;font-size:14px}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ã‹ã‚“ãŸã‚“æ–‡å­—ãŠã“ã—</h1>
      <div class="toolbar">
        <button id="btnStart" class="primary">ğŸ™ï¸ é–‹å§‹</button>
        <button id="btnPause" disabled>â¸ ä¸€æ™‚åœæ­¢</button>
        <button id="btnResume" disabled>â–¶ å†é–‹</button>
        <button id="btnStop" class="danger" disabled>â–  åœæ­¢</button>
        <button id="btnQuickSave" title="ç¾åœ¨ã®æ–‡å­—ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜">ğŸ’¾ ä¿å­˜</button>
        <button id="btnCopy" title="ç¾åœ¨ã®æ–‡å­—ã‚’ã‚³ãƒ”ãƒ¼">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        <button id="btnClear" class="danger" title="å…¨æ¶ˆå»">ğŸ—‘ å‰Šé™¤</button>
        <span class="badge" id="status">å¾…æ©Ÿä¸­</span>
      </div>
      <div class="row">
        <label class="badge" style="background:#fff">ğŸ¤ ãƒã‚¤ã‚¯:
          <select id="micSelect" style="margin-left:6px"></select>
        </label>
        <label class="toggle">
          <input type="checkbox" id="chkGrammar" />
          èªå½™è¾æ›¸ONï¼ˆè‡ªå®…ãªã©åˆ¶é™ã®ãªã„ç’°å¢ƒã§æ¨å¥¨ï¼‰
        </label>
        <span class="badge">æ—¥æœ¬èªå›ºå®šï¼ˆja-JPï¼‰</span>
        <span class="badge">æ¨å¥¨: PC Chrome / Edge</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="panel">
      <h2>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼ˆWeb Speech APIï¼‰</h2>
      <p class="note">iOS Safari ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èªè­˜ã«æœªå¯¾å¿œï¼ˆéŒ²éŸ³ã¯å¯ï¼‰ã€‚ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¾ã¾ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
      <div class="meters">
        <div class="mic-bubble" id="micBubble"><div class="mic-dot"></div></div>
        <div>
          <div class="bar-wrap"><div class="bar" id="levelBar"></div></div>
          <canvas id="wave"></canvas>
        </div>
      </div>
      <div id="log"></div>
    </div>
  </main>

  <footer>
    ğŸ™ï¸ é–‹å§‹ â†’ ãƒã‚¤ã‚¯è¨±å¯ â†’ ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒå‹•ã‘ã°å…¥åŠ›ä¸­ã€‚<br/>
    ä¼šç¤¾ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ã¯èªå½™è¾æ›¸ã‚’OFFã«ã™ã‚‹ã®ãŒå®‰å®šï¼ˆãƒ–ãƒ­ãƒƒã‚¯å›é¿ï¼‰ã€‚è‡ªå®…ç­‰ã§ã¯ONã«ã—ã¦æ­¯ç§‘ç”¨èªã®èª¤å¤‰æ›ã‚’æŠ‘åˆ¶ã§ãã¾ã™ã€‚
  </footer>

<script>
(() => {
  // ===== æ­¯ç§‘å‘ã‘ é »å‡ºèªå½™ï¼ˆãƒã‚¤ã‚¢ã‚¹ç”¨ï¼šå®Œå…¨ãƒ»çœç•¥ãªã—ï¼‰ =====
  const DENTAL_KEYWORDS = [
    // åˆ†é‡1: æ­¯ç§‘åˆ†é‡ï¼ˆè¨ºç™‚ãƒ»ä¸€èˆ¬ï¼‰
    "æ­¯ç§‘","ãƒ‡ãƒ³ã‚¿ãƒ«","æ­¯ç§‘åŒ»é™¢","æ­¯ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯","è¨ºç™‚æ‰€","æ­¯ç§‘åŒ»å¸«","æ­¯ç§‘è¡›ç”Ÿå£«","æ­¯ç§‘æŠ€å·¥å£«","å—ä»˜","åŠ©æ‰‹",
    "ä¸€èˆ¬æ­¯ç§‘","äºˆé˜²æ­¯ç§‘","å°å…æ­¯ç§‘","çŸ¯æ­£æ­¯ç§‘","å£è…”å¤–ç§‘","å¯©ç¾æ­¯ç§‘","ã‚¤ãƒ³ãƒ—ãƒ©ãƒ³ãƒˆ",
    "ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°","ãƒ«ãƒ¼ãƒˆãƒ—ãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°","PMTC","ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°",
    "ä¿é™ºè¨ºç™‚","è‡ªè²»è¨ºç™‚","æ··åˆè¨ºç™‚","ãƒ¬ã‚»ãƒ—ãƒˆ","ãƒ¬ã‚»ã‚³ãƒ³","åˆ†æ","è¿”æˆ»","çª“å£è² æ‹…",
    "ã‚«ãƒ«ãƒ†","é›»å­ã‚«ãƒ«ãƒ†","æ—¢å¾€æ­´","ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼","æœè–¬",
    "å£è…”å†…","å’¬åˆ","æ­¯å‘¨ç—…","ã†è•","è™«æ­¯","æ ¹ç®¡æ²»ç™‚","æŠœé«„","æŠœæ­¯","åŸ‹ä¼æ­¯",
    "è£œç¶´","ã‚¯ãƒ©ã‚¦ãƒ³","ãƒ–ãƒªãƒƒã‚¸","ã‚¤ãƒ³ãƒ¬ãƒ¼","ã‚¢ãƒ³ãƒ¬ãƒ¼","ç¾©æ­¯","åºŠç”¨ãƒ¬ã‚¸ãƒ³",
    "ã‚¢ãƒ©ã‚¤ãƒŠãƒ¼","ãƒ–ãƒ©ã‚±ãƒƒãƒˆ","ãƒ¯ã‚¤ãƒ¤ãƒ¼","ä¿å®šè£…ç½®",
    "å’¬åˆå™¨","ãƒ•ã‚§ã‚¤ã‚¹ãƒœã‚¦","å°è±¡","å’¬åˆæ¡å¾—",
    "Xç·š","ãƒ¬ãƒ³ãƒˆã‚²ãƒ³","ãƒ‡ãƒ³ã‚¿ãƒ«","ãƒ‘ãƒãƒ©ãƒ","ã‚»ãƒ•ã‚¡ãƒ­","CBCT",
    "æ»…èŒ","æ¶ˆæ¯’","ã‚ªãƒ¼ãƒˆã‚¯ãƒ¬ãƒ¼ãƒ–","ãƒ‡ã‚£ã‚¹ãƒ","æ„ŸæŸ“å¯¾ç­–",
    "ã‚¢ãƒã‚¤ãƒ³ãƒˆ","ãƒªã‚³ãƒ¼ãƒ«","å®šæœŸæ¤œè¨º","åˆè¨º","å†åˆè¨º","å†è¨º",

    // åˆ†é‡2: é–‹æ¥­æ”¯æ´ãƒ»çµŒå–¶ï¼ˆè¨ˆç”»ãƒ»å±Šã‘å‡ºãƒ»ä½“åˆ¶ï¼‰
    "é–‹æ¥­æ”¯æ´","é–‹æ¥­æº–å‚™","äº‹æ¥­è¨ˆç”»","è³‡é‡‘è¨ˆç”»","èè³‡","äº‹æ¥­æ€§è©•ä¾¡",
    "ç‰©ä»¶é¸å®š","ãƒ†ãƒŠãƒ³ãƒˆ","å†…è£…","ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ","å‹•ç·šè¨­è¨ˆ",
    "åŒ»ç™‚æ©Ÿå™¨é¸å®š","ä»•å…¥ã‚Œ","ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼","ä¿å®ˆå¥‘ç´„",
    "ä¿å¥æ‰€","é–‹è¨­å±Š","ç®¡ç†è€…é¸ä»»","æ–½è¨­åŸºæº–","å±Šå‡º",
    "åŠ´å‹™ç®¡ç†","å°±æ¥­è¦å‰‡","æ¡ç”¨","é¢æ¥","ç ”ä¿®","è³ƒé‡‘","ç¤¾ä¼šä¿é™º","å‹¤æ€ ",
    "ã‚·ãƒ•ãƒˆ","ã‚¢ã‚µã‚¤ãƒ³","æ¥­å‹™åˆ†æ‹…","æ¨™æº–åŒ–","ãƒãƒ‹ãƒ¥ã‚¢ãƒ«",
    "KPIè¨­è¨ˆ","æœˆæ¬¡MTG","ç›®æ¨™ç®¡ç†","é‹å–¶æ”¹å–„","æ¥­å‹™ãƒ•ãƒ­ãƒ¼",
    "ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°","ãƒ­ã‚´","ã‚µã‚¤ãƒ³","å¤–è£…","å†…è£…ãƒ‡ã‚¶ã‚¤ãƒ³",
    "ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸","äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ","SNS","Googleãƒãƒƒãƒ—","å£ã‚³ãƒŸ",
    "é–‹æ¥­è²»","å‰µç«‹è²»","é–‹æ¥­è³‡é‡‘","é‹è»¢è³‡é‡‘","ãƒªãƒ¼ã‚¹","å‰²è³¦",

    // åˆ†é‡3: åŒ»ç™‚æ©Ÿå™¨ãƒ»ææ–™
    "ãƒ¦ãƒ‹ãƒƒãƒˆ","ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚µãƒ¼","ãƒã‚­ãƒ¥ãƒ¼ãƒ ","å£è…”å¤–ãƒã‚­ãƒ¥ãƒ¼ãƒ ",
    "ã‚ªãƒ¼ãƒˆã‚¯ãƒ¬ãƒ¼ãƒ–","è¶…éŸ³æ³¢ã‚¹ã‚±ãƒ¼ãƒ©ãƒ¼","ã‚¿ãƒ¼ãƒ“ãƒ³","ã‚³ãƒ³ãƒˆãƒ©","ãƒãƒ³ãƒ‰ãƒ”ãƒ¼ã‚¹",
    "å£è…”å†…ã‚«ãƒ¡ãƒ©","ãƒã‚¤ã‚¯ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—","å£è…”å¤–ã‚«ãƒ¡ãƒ©",
    "ãƒ‡ã‚¸ã‚¿ãƒ«ã‚»ãƒ³ã‚µãƒ¼","ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ³ã‚°ãƒ—ãƒ¬ãƒ¼ãƒˆ",
    "CAD/CAM","ãƒŸãƒªãƒ³ã‚°","3Dãƒ—ãƒªãƒ³ã‚¿ãƒ¼","ä¸‰æ¬¡å…ƒãƒ—ãƒªãƒ³ã‚¿","ã‚¸ãƒ«ã‚³ãƒ‹ã‚¢","e.max","ã‚¤ãƒ¼ãƒãƒƒã‚¯ã‚¹",
    "æ¥ç€æ","ã‚»ãƒ¡ãƒ³ãƒˆ","ã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆãƒ¬ã‚¸ãƒ³","ã‚·ãƒ¼ãƒ©ãƒ³ãƒˆ",
    "ãƒ©ãƒãƒ¼ãƒ€ãƒ ","ã‚¢ã‚¤ã‚½ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³","ã‚µãƒ¼ã‚¸ã‚«ãƒ«ã‚¬ã‚¤ãƒ‰",

    // åˆ†é‡4: ä¿é™ºåˆ¶åº¦ãƒ»ç‚¹æ•°ãƒ»è«‹æ±‚
    "ç‚¹æ•°","ç®—å®š","åŠ ç®—","ç®—å®šè¦ä»¶","æ–½è¨­åŸºæº–",
    "åˆè¨ºæ–™","å†è¨ºæ–™","ç®¡ç†æ–™","ç”»åƒè¨ºæ–­","æŠ•è–¬","åœ¨å®…",
    "é‡‘ãƒ‘ãƒ©","éŠ€åˆé‡‘","ä¿é™ºãƒ–ãƒªãƒƒã‚¸","ä¿é™ºã‚¯ãƒ©ã‚¦ãƒ³",
    "å›½ä¿","ç¤¾ä¿","å¾ŒæœŸé«˜é½¢","å…¬è²»","è² æ‹…å‰²åˆ",
    "ç®—å®šæ¼ã‚Œ","è¿”æˆ»","æŸ»å®š","ç–‘ç¾©ç…§ä¼š",

    // åˆ†é‡5: å—ä»˜ãƒ»é‹å–¶ãƒ»æ‚£è€…å¯¾å¿œ
    "å•è¨ºç¥¨","èª¬æ˜åŒæ„","ç½²å","åŒæ„æ›¸","æ—¢å¾€ç—‡",
    "äºˆç´„","ãƒªãƒã‚¤ãƒ³ãƒ‰","ã‚­ãƒ£ãƒ³ã‚»ãƒ«","å½“æ—¥ã‚­ãƒ£ãƒ³ã‚»ãƒ«","ãƒ‰ã‚¿ã‚­ãƒ£ãƒ³",
    "ä¼šè¨ˆ","ç¾é‡‘","ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹","ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ","äº¤é€šç³»","è«‹æ±‚æ›¸","é ˜åæ›¸","ã‚¤ãƒ³ãƒœã‚¤ã‚¹",
    "å€‹äººæƒ…å ±ä¿è­·","åŒæ„å–å¾—","ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£","ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—",
    "ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œ","è‹¦æƒ…","å†ç™ºé˜²æ­¢","å“è³ªç®¡ç†",

    // åˆ†é‡6: è²¡å‹™ãƒ»ä¼šè¨ˆãƒ»ç¨å‹™
    "è²¡å‹™è«¸è¡¨","æ±ºç®—æ›¸","è©¦ç®—è¡¨","æœˆæ¬¡æ±ºç®—",
    "è²¸å€Ÿå¯¾ç…§è¡¨","ãƒãƒ©ãƒ³ã‚¹ã‚·ãƒ¼ãƒˆ","BS",
    "æç›Šè¨ˆç®—æ›¸","PL","P/L","åç›Š","å£²ä¸Šé«˜","å£²ä¸ŠåŸä¾¡","ç²—åˆ©","å–¶æ¥­åˆ©ç›Š","çµŒå¸¸åˆ©ç›Š","å½“æœŸç´”åˆ©ç›Š",
    "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼è¨ˆç®—æ›¸","CF","ãƒ•ãƒªãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼",
    "å£²æ›é‡‘","è²·æ›é‡‘","æ£šå¸è³‡ç”£","å‰å—é‡‘","æœªåå…¥é‡‘","æœªæ‰•é‡‘",
    "å›ºå®šè³‡ç”£","æ¸›ä¾¡å„Ÿå´","ãƒªãƒ¼ã‚¹è³‡ç”£","ç„¡å½¢è³‡ç”£",
    "ç¹°å»¶è³‡ç”£","é–‹æ¥­è²»","å‰µç«‹è²»","ä¿é™ºç©ç«‹é‡‘",
    "ç´”è³‡ç”£","è³‡æœ¬é‡‘","åˆ©ç›Šå‰°ä½™é‡‘",
    "è² å‚µ","æµå‹•è² å‚µ","å›ºå®šè² å‚µ","å€Ÿå…¥é‡‘","ãƒªãƒ¼ã‚¹å‚µå‹™",
    "åŸä¾¡","å¤‰å‹•è²»","å›ºå®šè²»","äººä»¶è²»","æ³•å®šç¦åˆ©è²»","åœ°ä»£å®¶è³ƒ","æ°´é“å…‰ç†±è²»","æ¸›ä¾¡å„Ÿå´è²»","åºƒå‘Šå®£ä¼è²»","äº¤éš›è²»","æ—…è²»äº¤é€šè²»","é€šä¿¡è²»","æ¶ˆè€—å“è²»",
    "è³‡é‡‘ç¹°ã‚Š","é‹è»¢è³‡é‡‘","è³‡é‡‘ç¹°ã‚Šè¡¨","ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼","å›åã‚µã‚¤ãƒˆ","æ”¯æ‰•ã‚µã‚¤ãƒˆ",
    "äºˆç®—","äºˆå®Ÿç®¡ç†","ä¹–é›¢","æœˆæ¬¡å ±å‘Š","KPI",
    "ç¨å‹™","æ¶ˆè²»ç¨","ä»•å…¥ç¨é¡æ§é™¤","ã‚¤ãƒ³ãƒœã‚¤ã‚¹åˆ¶åº¦","æºæ³‰æ‰€å¾—ç¨","å¹´æœ«èª¿æ•´","æ³•äººç¨","ä½æ°‘ç¨","äº‹æ¥­ç¨",
    "ä¼šè¨ˆã‚½ãƒ•ãƒˆ","ã‚¯ãƒ©ã‚¦ãƒ‰ä¼šè¨ˆ","ä»•è¨³","ç·å‹˜å®šå…ƒå¸³",

    // åˆ†é‡7: KPIãƒ»åˆ†æ
    "æ–°æ‚£æ•°","å†åˆè¨º","å†æ¥ç‡","äºˆç´„ç‡","æ¥é™¢ç‡","ãƒªã‚³ãƒ¼ãƒ«ç‡",
    "è‡ªè²»æ¯”ç‡","è‡ªè²»ç‡","å¹³å‡å˜ä¾¡","å®¢å˜ä¾¡",
    "ãƒ¦ãƒ‹ãƒƒãƒˆç¨¼åƒç‡","ãƒã‚§ã‚¢ã‚¿ã‚¤ãƒ ","æ»åœ¨æ™‚é–“","æ–½è¡“æ™‚é–“",
    "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç‡","ãƒ‰ã‚¿ã‚­ãƒ£ãƒ³ç‡","æœªåé‡‘","å›åç‡",
    "äººä»¶è²»ç‡","åºƒå‘Šè²»ç‡","å®¶è³ƒæ¯”ç‡","æç›Šåˆ†å²ç‚¹",
    "è¨ºç™‚å ±é…¬","ç‚¹æ•°å˜ä¾¡","ãƒ¬ã‚»ãƒ—ãƒˆä»¶æ•°","ç®—å®šä»¶æ•°",

    // åˆ†é‡8: è¡¨è¨˜ã‚†ã‚Œãƒ»èª­ã¿ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
    "ã—ã‹","ãƒ¬ã‚»","æ¤ç«‹","è¢«ã›ç‰©","ã‹ã¶ã›",
    "ãƒã‚¦ã‚¹ãƒ”ãƒ¼ã‚¹çŸ¯æ­£","ã‚¯ãƒªã‚¢ã‚¢ãƒ©ã‚¤ãƒŠãƒ¼",
    "CRå……å¡«","ãƒ¬ã‚¸ãƒ³å……å¡«",
    "å£å¤–ãƒã‚­ãƒ¥ãƒ¼ãƒ ",
    "ãƒ”ãƒ¼ã‚¨ãƒ«","ãƒ“ãƒ¼ã‚¨ã‚¹","ã‚·ãƒ¼ã‚¨ãƒ•"
  ];

  // ===== çŠ¶æ…‹ =====
  let recognizing=false, paused=false, recognizer=null, interimSpan=null, startTime=null;
  let micStream=null, audioCtx=null, analyser=null, timeData=null, rafId=null;
  let retryCount=0;
  const MAX_RETRY=6;
  let lastResultAt=Date.now();

  // è¦ç´ 
  const $=id=>document.getElementById(id);
  const logEl=$('log'), statusEl=$('status'), levelBar=$('levelBar'), micBubble=$('micBubble');
  const wave=$('wave'), wctx=wave.getContext('2d');
  const btnStart=$('btnStart'), btnPause=$('btnPause'), btnResume=$('btnResume'), btnStop=$('btnStop');
  const btnQuickSave=$('btnQuickSave'), btnCopy=$('btnCopy'), btnClear=$('btnClear');
  const micSelect=$('micSelect'), chkGrammar=$('chkGrammar');

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  const fmtTS=ms=>{const s=Math.floor(ms/1000);return`${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`};
  const nowTS=()=>startTime?fmtTS(Date.now()-startTime):'00:00:00';
  const setStatus=txt=>statusEl.textContent=txt;

  function addSegment(text,{interim=false}={}) {
    const seg=document.createElement('div'); seg.className='seg';
    const ts=document.createElement('span'); ts.className='ts'; ts.textContent=`[${nowTS()}]`;
    const body=document.createElement('span'); body.className=interim?'interim':'final'; body.textContent=text;
    seg.appendChild(ts); seg.appendChild(body); logEl.appendChild(seg);
    interimSpan = interim ? body : null;
    seg.scrollIntoView({behavior:'smooth', block:'end'});
    backupSave();
  }
  function replaceInterim(text){ if(interimSpan) interimSpan.textContent=text; else addSegment(text,{interim:true}); }

  function backupSave(){ localStorage.setItem('transcript_html_v1', logEl.innerHTML); }
  function backupLoad(){ const html=localStorage.getItem('transcript_html_v1'); if (html) logEl.innerHTML = html; }
  setInterval(()=>{ if(recognizing || logEl.innerHTML) backupSave(); }, 10000);

  function quickSaveSnapshot(){
    const text = Array.from(logEl.querySelectorAll('.seg')).map(seg=>{
      const ts=seg.querySelector('.ts')?.textContent??''; const body=seg.querySelector('.final,.interim')?.textContent??'';
      return `${ts} ${body}`.trim();
    }).join('\n');
    const id=new Date().toISOString();
    const item={ id, savedAt:id, text, html:logEl.innerHTML };
    const key='transcript_snapshots_v1';
    const arr=JSON.parse(localStorage.getItem(key) || '[]'); arr.push(item);
    localStorage.setItem(key, JSON.stringify(arr));
    flash('ä¿å­˜ã—ã¾ã—ãŸ');
  }

  async function copyAll(){
    const text = Array.from(logEl.querySelectorAll('.seg')).map(seg=>{
      const ts=seg.querySelector('.ts')?.textContent??''; const body=seg.querySelector('.final,.interim')?.textContent??'';
      return `${ts} ${body}`.trim();
    }).join('\n');
    try{
      if (navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
      else {
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      }
      flash('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    } catch(e) {
      console.error(e); flash('ã‚³ãƒ”ãƒ¼å¤±æ•—');
    }
  }

  function flash(msg){ setStatus(msg); setTimeout(()=> setStatus(recognizing ? 'èªè­˜ä¸­...' : 'å¾…æ©Ÿä¸­'), 1500); }

  // ===== ãƒ‡ãƒã‚¤ã‚¹é¸æŠ =====
  async function listMics(){
    try {
      await navigator.mediaDevices.getUserMedia({ audio:true });
    } catch(_) { /* æ¨©é™æœªè¨±å¯ã§ã‚‚åˆ—æŒ™ã§ãã‚‹ç’°å¢ƒã‚‚ã‚ã‚‹ */ }
    const devices = await navigator.mediaDevices.enumerateDevices();
    const mics = devices.filter(d=>d.kind==='audioinput');
    micSelect.innerHTML = mics.map(d=>`<option value="${d.deviceId}">${d.label || 'ãƒã‚¤ã‚¯'}</option>`).join('');
    // å‰å›é¸æŠã®å¾©å…ƒ
    const savedId = localStorage.getItem('preferred_mic_id');
    if (savedId && mics.some(m=>m.deviceId===savedId)) micSelect.value = savedId;
  }

  micSelect.addEventListener('change', ()=>{
    localStorage.setItem('preferred_mic_id', micSelect.value || '');
  });

  chkGrammar.addEventListener('change', ()=>{
    localStorage.setItem('use_grammar', chkGrammar.checked ? '1' : '0');
  });

  // ===== ãƒ¡ãƒ¼ã‚¿ãƒ¼åˆæœŸåŒ–ï¼ˆé¸æŠãƒã‚¤ã‚¯ï¼‰ =====
  async function initMicAndMeters(){
    if (micStream) return micStream;
    const deviceId = micSelect.value;
    micStream = await navigator.mediaDevices.getUserMedia({
      audio:{
        deviceId: deviceId ? { exact: deviceId } : undefined,
        echoCancellation:true, noiseSuppression:true, autoGainControl:true,
        channelCount:1, sampleRate:48000
      }
    });

    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
    const source = audioCtx.createMediaStreamSource(micStream);
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
    timeData = new Uint8Array(analyser.fftSize); source.connect(analyser);

    wave.width = wave.clientWidth * devicePixelRatio;
    wave.height = wave.clientHeight * devicePixelRatio;

    const loop = () => {
      analyser.getByteTimeDomainData(timeData);
      let sum=0; for (let i=0;i<timeData.length;i++){ const v=(timeData[i]-128)/128; sum += v*v; }
      const rms=Math.sqrt(sum/timeData.length), level=Math.min(1, rms*4);
      levelBar.style.width = (level*100).toFixed(0)+'%';
      micBubble.classList.toggle('on', level>0.04);
      micBubble.style.transform = `scale(${(1+Math.min(0.25, level*0.8)).toFixed(3)})`;

      const W=wave.width, H=wave.height, mid=H/2; const ctx=wctx; ctx.clearRect(0,0,W,H);
      ctx.lineWidth=2*devicePixelRatio; ctx.strokeStyle='#2563eb';
      ctx.beginPath(); const step=Math.ceil(timeData.length/W);
      for(let x=0,i=0;x<W;x++,i+=step){
        const yv=(timeData[Math.min(i,timeData.length-1)]-128)/128;
        const y=mid + yv*(H/2 - 4*devicePixelRatio);
        if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();

      rafId = requestAnimationFrame(loop);
    };
    rafId = requestAnimationFrame(loop);
    return micStream;
  }

  function stopMicAndMeters(){
    if (rafId) cancelAnimationFrame(rafId), rafId=null;
    if (audioCtx) audioCtx.close().catch(()=>{});
    micBubble.style.transform='scale(1)'; micBubble.classList.remove('on');
  }

  // ===== å†æ¥ç¶šï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰ =====
  function restartWithBackoff(rec){
    const delay = Math.min(30000, 500 * Math.pow(2, retryCount)) + Math.floor(Math.random()*300);
    retryCount++;
    setStatus(`å†æ¥ç¶šä¸­... (${retryCount})`);
    setTimeout(()=>{ try{ rec.start(); }catch{} }, delay);
  }

  // ===== éŸ³å£°èªè­˜ï¼ˆæ—¥æœ¬èªå›ºå®šï¼‹è¾æ›¸ãƒˆã‚°ãƒ«ï¼‰ =====
  function createRecognizer(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const SGL = window.SpeechGrammarList || window.webkitSpeechGrammarList;
    if (!SR) { alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ Web Speech API ã«æœªå¯¾å¿œã§ã™ã€‚Chrome/Edge ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚'); return null; }

    const r = new SR();
    r.lang = 'ja-JP';
    r.interimResults = true;
    r.continuous = true;
    r.maxAlternatives = 1;

    const useGrammar = !!chkGrammar.checked;
    if (useGrammar && SGL) {
      const grammars = new SGL();
      const jsgf = `#JSGF V1.0; grammar kws; public <kw> = ${DENTAL_KEYWORDS.join(' | ')} ;`;
      grammars.addFromString(jsgf, 1.0);
      r.grammars = grammars;
      console.log('èªå½™è¾æ›¸ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ');
    } else {
      console.log('èªå½™è¾æ›¸ã¯ç„¡åŠ¹ã§ã™ï¼ˆä¼šç¤¾ãƒãƒƒãƒˆå‘ã‘æ¨å¥¨ï¼‰');
    }

    r.onstart = () => { setStatus('èªè­˜ä¸­...ï¼ˆlang=ja-JPï¼‰'); retryCount = 0; lastResultAt = Date.now(); };
    r.onend   = () => {
      if (!recognizing || paused) { setStatus(paused ? 'ä¸€æ™‚åœæ­¢ä¸­' : 'åœæ­¢'); return; }
      if (retryCount < MAX_RETRY) restartWithBackoff(r);
      else setStatus('æ¥ç¶šã§ãã¾ã›ã‚“ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/æ‹¡å¼µæ©Ÿèƒ½/FWã‚’ç¢ºèªï¼‰');
    };
    r.onerror = (e) => {
      console.warn('Speech error:', e);
      if (!recognizing || paused) return;
      // ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ï¼š'network','no-speech','aborted'
      if (retryCount < MAX_RETRY) restartWithBackoff(r);
      else setStatus('æ¥ç¶šã§ãã¾ã›ã‚“ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/æ‹¡å¼µæ©Ÿèƒ½/FWã‚’ç¢ºèªï¼‰');
    };
    r.onresult = (ev) => {
      lastResultAt = Date.now();
      let interim='';
      for (let i=ev.resultIndex; i<ev.results.length; i++){
        const res=ev.results[i], txt=res[0].transcript;
        if (res.isFinal) {
          const cleaned = txt.trim().replace(/\s+/g,' ')
            .replace(/(ã§ã™|ã¾ã™)(?!ã€‚|ï¼|ï¼Ÿ)/g, '$1ã€‚');
          addSegment(cleaned, {interim:false});
        } else {
          interim += txt;
        }
      }
      if (interim) replaceInterim(interim);
    };
    return r;
  }

  // ===== ã‚¦ã‚©ãƒƒãƒãƒ‰ãƒƒã‚°ï¼š30ç§’é–“çµæœãªã—â†’å†èµ·å‹• =====
  setInterval(()=>{
    if (recognizing && !paused && Date.now() - lastResultAt > 30000) {
      try { recognizer.stop(); } catch {}
      // onend â†’ å†æ¥ç¶šãƒ•ãƒ­ãƒ¼ã¸
    }
  }, 5000);

  // ===== ãƒœã‚¿ãƒ³å‹•ä½œ =====
  btnStart.onclick = async () => {
    if (recognizing) return;
    backupLoad(); startTime = Date.now();

    // å‰å›ã®è¾æ›¸ON/OFFè¨­å®šã‚’å¾©å…ƒ
    const savedGrammar = localStorage.getItem('use_grammar');
    if (savedGrammar !== null) chkGrammar.checked = savedGrammar === '1';

    try { await initMicAndMeters(); }
    catch (e) { alert('ãƒã‚¤ã‚¯æ¨©é™ã‚’ã”ç¢ºèªãã ã•ã„ï¼ˆğŸ”’â†’ã‚µã‚¤ãƒˆã®è¨­å®šï¼‰'); console.error(e); return; }

    recognizer = createRecognizer(); if (!recognizer) return;
    recognizing = true; paused = false;

    btnStart.disabled = true; btnPause.disabled = false; btnResume.disabled = true; btnStop.disabled = false;
    try { recognizer.start(); } catch(e){}
    setStatus('èªè­˜ä¸­...ï¼ˆlang=ja-JPï¼‰');
  };

  btnPause.onclick = () => {
    if (!recognizing || paused) return;
    paused = true;
    try { recognizer.stop(); } catch{}
    setStatus('ä¸€æ™‚åœæ­¢ä¸­');
    btnPause.disabled = true; btnResume.disabled = false;
  };

  btnResume.onclick = () => {
    if (!recognizing || !paused) return;
    paused = false;
    try { recognizer.start(); } catch{}
    setStatus('èªè­˜ä¸­...ï¼ˆlang=ja-JPï¼‰');
    btnPause.disabled = false; btnResume.disabled = true;
  };

  btnStop.onclick = () => {
    recognizing = false; paused = false;
    try { recognizer.stop(); } catch{}
    stopMicAndMeters();
    btnStart.disabled = false; btnPause.disabled = true; btnResume.disabled = true; btnStop.disabled = true;
    setStatus('åœæ­¢');
    backupSave();
  };

  btnQuickSave.onclick = () => quickSaveSnapshot();
  btnCopy.onclick      = () => copyAll();
  btnClear.onclick     = () => {
    if (!confirm('ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    logEl.innerHTML = '';
    localStorage.removeItem('transcript_html_v1');
    setStatus('å‰Šé™¤ã—ã¾ã—ãŸ'); setTimeout(()=>setStatus('å¾…æ©Ÿä¸­'), 1500);
  };

  // åˆæœŸåŒ–ï¼šãƒã‚¤ã‚¯ä¸€è¦§ãƒ»è¾æ›¸è¨­å®šå¾©å…ƒ
  (async () => {
    await listMics();
    const savedGrammar = localStorage.getItem('use_grammar');
    if (savedGrammar !== null) chkGrammar.checked = savedGrammar === '1';
  })();
})();
</script>
</body>
</html>

